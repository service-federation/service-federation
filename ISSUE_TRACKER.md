| ID       | Status  | Priority | Complexity | Description |
|----------|---------|----------|------------|-------------|
| SF-00080 | Done | MEDIUM | Low medium | Unify stop/cleanup paths — Extracted `StopResult` enum, `stop_service_by_state()`, and `remove_orphan_containers_for_workdir()` into `commands/lifecycle.rs`. Refactored `stop_remaining_state_services` and `run_stop_from_state` in `commands/stop.rs` to use the shared helpers, eliminating duplicated PID/container stop logic and Docker orphan cleanup. |
| SF-00081 | Done | MEDIUM | Low medium | Make orchestrator builder the sole construction path — Added `randomize_ports`, `replace_mode`, and `readonly` builder methods to `OrchestratorBuilder`. Refactored `main.rs` to use single `Orchestrator::builder()...build().await?` call. Builder handles `initialize()` vs `initialize_readonly()` based on `readonly` flag. |
| SF-00082 | Done | LOW | Low medium | Split main.rs command dispatch — Restructured `run()` from tangled two-pass match into three clean dispatch tiers: (1) no-config commands, (2) config-only commands (Docker, Debug), (3) orchestrator commands. Extracted `resolve_work_dir` helper to eliminate 3x duplicated work-directory resolution. Net reduction of 28 lines. |
| SF-00083 | Done | LOW | Low medium | Dry-run duplicates port conflict derivation — Unified all three port conflict paths (`--replace`, post-start diagnostics, dry-run) to use `get_port_resolutions()` instead of manual parameter name lookup + parse. Removed unused `get_port_parameter_names` from Orchestrator. |
| SF-00093 | Done | HIGH | Low | Port allocation `0.0.0.0` bind fails on Linux CI — `allocate_random_port` binds `127.0.0.1:0` then tries `0.0.0.0:PORT`, which fails on Linux because the kernel treats them as overlapping. All port allocator tests fail on ubuntu-latest. Fixed: made `0.0.0.0` bind best-effort in all PortAllocator methods. |
| SF-00094 | Done | LOW | Low | Broken rustdoc links — `[`initialize`]` in core.rs:390, `[`purge_stale_services`]` in sqlite.rs:1780, `[`mark_dead_services`]` in sqlite.rs:1848 are unresolved. Fixed: qualified with type names. |
| SF-00095 | Done | HIGH | High medium | State cleared before container actually stopped — Fixed: `docker.rs` now uses `docker rm -f` with retry logic (3 attempts, exponential backoff). Returns `Err` if removal fails, preventing `stop_service_impl()` from unregistering. Added orphan detection at startup (warns user to run `fed stop` or `fed clean`). Added integration tests. |
| SF-00096 | Done | HIGH | Low | Orphan detection warns but stop/clean don't remove orphans — Fixed: Added `remove_orphaned_containers()` method to Orchestrator. Called from `fed stop` after stopping tracked services, and from `fed clean` before cleaning volumes. Also added to `run_stop_from_state` fallback mode. |
| SF-00097 | Done | HIGH | High medium | Port conflict errors are a wall of text with no fix — Fixed: (1) Parse port conflicts into clean error "service – port X already allocated", (2) Fixed `--replace` flag to actually kill blocking processes/containers (was just picking alt ports), (3) Clean up orphaned containers after failed start, (4) Show actionable hint: "fed start --replace". |
| SF-00098 | Done | HIGH | Low medium | Process services leave orphan processes when they crash — Fixed: Added `detect_orphan_processes()` and `remove_orphaned_processes()` to Orchestrator. Called from `fed stop` after stopping tracked services, and from `fed clean` before cleaning. Kills orphan processes with SIGTERM/SIGKILL. |
| SF-00099 | Done | MEDIUM | High medium | Replace `println!` with structured output abstraction — Created `UserOutput` trait (`status`, `success`, `warning`, `error`, `progress`, `finish_progress`, `blank`) with `CliOutput` (stdout/stderr) and `QuietOutput` (suppressed for TUI). Migrated all 18 command modules and main.rs dispatch. Commands receive `&dyn UserOutput`, decoupling CLI rendering from command logic. |
| SF-00100 | Done | MEDIUM | Low | Use `Status` enum in state persistence layer — Changed `ServiceState.status` from `String` to `Status` enum with `FromStr`. Parse at SQLite boundary. |
| SF-00101 | Done | MEDIUM | Low | Replace blocking `std::process::Command` in async functions — Replaced with `tokio::process::Command` in `commands/lifecycle.rs` async functions. |
| SF-00102 | Done | MEDIUM | Very high | Split orchestrator god object — Extracted 4 modules from core.rs (2329 → 1504 lines, 35% reduction): `scripts.rs` (ScriptRunner), `orphans.rs` (OrphanCleaner), `health.rs` (HealthCheckRunner), `ports.rs` (port utilities). All runners hold `&Orchestrator` and are constructed on-demand. Public API unchanged. |
| SF-00103 | Done | MEDIUM | High medium | Unify error boundary between lib and command crates — Standardized all commands on `anyhow::Result`. Removed unnecessary `map_err` wrappers in main.rs. Converted string errors in `script.rs` and `session.rs` to library Error variants (`ScriptNotFound`, `Session`) so `suggestion()` hints work consistently. |
| SF-00104 | Done | CRITICAL | High medium | Isolated script clears shared state tracker — Fixed: Added `SqliteStateTracker::new_ephemeral()` which uses an in-memory SQLite database with no file lock. `run_script_isolated()` now replaces the child orchestrator's state tracker with an ephemeral one, so `clear()` and all writes stay in-memory and never touch the parent's `.fed/lock.db`. |
| SF-00105 | Done | HIGH | Low medium | Script failure bypasses cleanup for started dependencies — Fixed: Replaced `std::process::exit(code)` with `Err(ScriptFailed { name, exit_code })`. Error propagates through normal control flow so Drop impls and async cleanup run. `main()` extracts exit code from `ScriptFailed` silently (script's own stderr is the user feedback). |
| SF-00106 | Done | LOW | Low | `QuietOutput` struct is never constructed — Removed. TUI has its own rendering and doesn't use `UserOutput`. |
| SF-00107 | Done | HIGH | Low medium | Reverse lock ordering in dependency health propagation — Fixed: restructured Stop and Restart paths in `handle_dependency_health_propagation()` to release service mutex before acquiring `state_tracker`. Manager lock is now scoped to just the stop/start operation, then state_tracker is acquired separately. |
| SF-00108 | Done | HIGH | Low | Health check assumes container alive on docker failure — Fixed: `orchestrator/health.rs:251` changed `unwrap_or(true)` to `unwrap_or(false)`. If `docker ps` fails, assume the container is dead rather than alive. |
| SF-00109 | Done | MEDIUM | Low | Non-interactive script timeout hardcoded at 5 minutes — Fixed: Added optional `timeout` field to `Script` config struct (e.g., `"10m"`, `"30s"`, `"600"`). Uses existing `parse_duration_string()`. Defaults to 5 minutes when not set. |
| SF-00110 | Done | LOW | Low | Docker container removal retry uses linear backoff despite comment saying exponential — Fixed: Changed `100 * attempt` to `100 * 2^attempt` for true exponential backoff (200ms, 400ms, 800ms). |
| SF-00111 | Done | MEDIUM | Low | Silent state tracker failures in cleanup paths — Fixed: Replaced `let _ =` with `if let Err(e) = ... { tracing::warn!(...) }` in `orphans.rs`, `stop.rs`, and `monitoring.rs`. Cleanup still continues on failure but now logs diagnostics. |
| SF-00112 | Done | MEDIUM | Low medium | TUI silently swallows service control errors — Fixed: All service control operations (toggle, restart) in all views (dashboard, details, graph) now display errors via `set_status()` with `StatusLevel::Error` instead of silently dropping with `let _ =` or crashing with `?`. |
| SF-00113 | Done | MEDIUM | Low | Tag expansion missing in build/clean/install — Fixed: Added `config.expand_service_selection()` calls to `build.rs`, `clean.rs`, and `install.rs` so `fed build @backend` works like `fed start @backend`. |
| SF-00114 | Done | LOW | Low | Docker error messages missing service name context — Fixed: Added service name to `docker rm` timeout error, volume/port validation errors, and `map_err` wrappers at call sites where `self.name` is available. |
| SF-00115 | Done | MEDIUM | Low | Undefined service type accepted at parse time — Fixed: `Config::validate()` now rejects services with no type-defining field with a clear error listing valid options (process, image, gradle_task, compose_file+compose_service). |
| SF-00116 | Done | LOW | Low | Invalid duration strings silently fall back to defaults — Fixed: `Config::validate()` now validates all duration strings (grace_period, healthcheck timeout, script timeout) at parse time, returning clear errors instead of silently defaulting. |
| SF-00117 | Done | CRITICAL | Low medium | Orphan detection compares `service_type == "docker"` but stored value is Debug-formatted `"Docker"` — filter never matches, every Docker container appears orphaned. Fixed: Added `Display`/`FromStr` and `Serialize`/`Deserialize` to `ServiceType` enum. Changed `ServiceState.service_type` from `String` to `ServiceType`. Parse at SQLite boundary (3 read sites + 1 write site). Fixed orphan filter to use `ServiceType::Docker`. Downstream display sites use `.to_string()`. |
| SF-00118 | Done | HIGH | Low medium | Docker commands missing timeouts — Fixed: Wrapped `docker stop`, `docker kill`, `docker exec` (healthcheck), `docker inspect`, `docker logs` in `tokio::time::timeout`. All Docker commands now have consistent timeout handling. |
| SF-00119 | Pending | HIGH | Low | PID reuse not validated in `ProcessService::stop()` — detached mode stop (process.rs:546-603) uses stored PID without checking process start time. `validate_pid_start_time()` exists in lifecycle.rs but isn't called from the service layer. Could kill wrong process after PID recycling. |
| SF-00120 | Done | HIGH | Low | Orphan cleaner kills individual PIDs not process groups — Fixed: Uses `getpgid()` to detect process group leaders, then `killpg()` for SIGTERM/SIGKILL. Falls back to individual `kill()` for non-leaders. Matches `ProcessService::stop()` behavior. |
| SF-00121 | Pending | MEDIUM | Low | `Error::Config` used as catch-all for 50+ unrelated errors — Docker errors, filesystem errors, script spawn errors all use `Error::Config(String)`. Prevents structured error matching. Split into `Error::Docker`, `Error::Process`, `Error::Filesystem` etc. |
| SF-00122 | Done | MEDIUM | Low | Duplicated `parse_duration_string` — Fixed: Removed private duplicate from config/service.rs, now imports and uses the public one from config/duration.rs. |
| SF-00123 | Pending | MEDIUM | Low medium | `restore_process_pid` and `restore_gradle_pid` are near-identical — factory.rs:322-467. Both downcast to specific type, validate PID via kill(nix_pid, None), call set_pid(). Only differs in downcast target. Extract shared helper or use trait. |
| SF-00124 | Pending | MEDIUM | Low | Missing signal handlers for non-watch commands — `fed stop` interrupted with Ctrl+C exits without cleanup. Only watch mode has proper SIGINT/SIGTERM handlers. |
| SF-00125 | Pending | MEDIUM | Low medium | Pure functions with zero test coverage — `validate_pid_start_time` (lifecycle.rs:143, safety-critical), `script_uses_positional_params` (scripts.rs:437), `expand_service_selection` (config/types.rs:90), `apply_state_transition` (sqlite.rs:952), `get_value_for_environment` (config/parameter.rs:51). |
| SF-00126 | Pending | MEDIUM | Low medium | State tracker CRUD operations untested — sqlite.rs: `register_service`, `unregister_service`, `update_service_status`, `apply_state_transition`, `mark_dead_services`, `purge_stale_services`, port persistence. All zero test coverage. |
| SF-00127 | Pending | LOW | Low | Error messages matched via `.contains()` for control flow — error.rs:279 matches `"database is locked"`, commands/logs.rs:44 matches `"Service not found"`, commands/start.rs:164 same. Should use `matches!()` on error variants. |
| SF-00128 | Done | LOW | Low | `OutputMode` has no `FromStr` — Fixed: Added `FromStr` impl to `OutputMode` with case-insensitive matching. Simplified main.rs to use `mode.parse::<OutputMode>()`. |
| SF-00129 | Done | LOW | Low | ANSI escape codes hardcoded in validation error messages — Fixed: Removed all raw ANSI escape sequences from validation.rs error messages. Box-drawing characters still provide visual structure without terminal dependency. |
| SF-00119 | Done | HIGH | Low | PID reuse not validated in ProcessService::stop() — Added started_at timestamp to ProcessService, set on start and PID restore. Detached stop path now validates PID start time before sending signals, skipping kill with a warning if PID was reused.
