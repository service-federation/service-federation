| ID       | Status  | Priority | Complexity | Description |
|----------|---------|----------|------------|-------------|
| SF-00080 | Done | MEDIUM | Low medium | Unify stop/cleanup paths — Extracted `StopResult` enum, `stop_service_by_state()`, and `remove_orphan_containers_for_workdir()` into `commands/lifecycle.rs`. Refactored `stop_remaining_state_services` and `run_stop_from_state` in `commands/stop.rs` to use the shared helpers, eliminating duplicated PID/container stop logic and Docker orphan cleanup. |
| SF-00081 | Done | MEDIUM | Low medium | Make orchestrator builder the sole construction path — Added `randomize_ports`, `replace_mode`, and `readonly` builder methods to `OrchestratorBuilder`. Refactored `main.rs` to use single `Orchestrator::builder()...build().await?` call. Builder handles `initialize()` vs `initialize_readonly()` based on `readonly` flag. |
| SF-00082 | Done | LOW | Low medium | Split main.rs command dispatch — Restructured `run()` from tangled two-pass match into three clean dispatch tiers: (1) no-config commands, (2) config-only commands (Docker, Debug), (3) orchestrator commands. Extracted `resolve_work_dir` helper to eliminate 3x duplicated work-directory resolution. Net reduction of 28 lines. |
| SF-00083 | Done | LOW | Low medium | Dry-run duplicates port conflict derivation — Unified all three port conflict paths (`--replace`, post-start diagnostics, dry-run) to use `get_port_resolutions()` instead of manual parameter name lookup + parse. Removed unused `get_port_parameter_names` from Orchestrator. |
| SF-00093 | Done | HIGH | Low | Port allocation `0.0.0.0` bind fails on Linux CI — `allocate_random_port` binds `127.0.0.1:0` then tries `0.0.0.0:PORT`, which fails on Linux because the kernel treats them as overlapping. All port allocator tests fail on ubuntu-latest. Fixed: made `0.0.0.0` bind best-effort in all PortAllocator methods. |
| SF-00094 | Done | LOW | Low | Broken rustdoc links — `[`initialize`]` in core.rs:390, `[`purge_stale_services`]` in sqlite.rs:1780, `[`mark_dead_services`]` in sqlite.rs:1848 are unresolved. Fixed: qualified with type names. |
| SF-00095 | Done | HIGH | High medium | State cleared before container actually stopped — Fixed: `docker.rs` now uses `docker rm -f` with retry logic (3 attempts, exponential backoff). Returns `Err` if removal fails, preventing `stop_service_impl()` from unregistering. Added orphan detection at startup (warns user to run `fed stop` or `fed clean`). Added integration tests. |
| SF-00096 | Done | HIGH | Low | Orphan detection warns but stop/clean don't remove orphans — Fixed: Added `remove_orphaned_containers()` method to Orchestrator. Called from `fed stop` after stopping tracked services, and from `fed clean` before cleaning volumes. Also added to `run_stop_from_state` fallback mode. |
| SF-00097 | Done | HIGH | High medium | Port conflict errors are a wall of text with no fix — Fixed: (1) Parse port conflicts into clean error "service – port X already allocated", (2) Fixed `--replace` flag to actually kill blocking processes/containers (was just picking alt ports), (3) Clean up orphaned containers after failed start, (4) Show actionable hint: "fed start --replace". |
| SF-00098 | Done | HIGH | Low medium | Process services leave orphan processes when they crash — Fixed: Added `detect_orphan_processes()` and `remove_orphaned_processes()` to Orchestrator. Called from `fed stop` after stopping tracked services, and from `fed clean` before cleaning. Kills orphan processes with SIGTERM/SIGKILL. |
| SF-00099 | Done | MEDIUM | High medium | Replace `println!` with structured output abstraction — Created `UserOutput` trait (`status`, `success`, `warning`, `error`, `progress`, `finish_progress`, `blank`) with `CliOutput` (stdout/stderr) and `QuietOutput` (suppressed for TUI). Migrated all 18 command modules and main.rs dispatch. Commands receive `&dyn UserOutput`, decoupling CLI rendering from command logic. |
| SF-00100 | Done | MEDIUM | Low | Use `Status` enum in state persistence layer — Changed `ServiceState.status` from `String` to `Status` enum with `FromStr`. Parse at SQLite boundary. |
| SF-00101 | Done | MEDIUM | Low | Replace blocking `std::process::Command` in async functions — Replaced with `tokio::process::Command` in `commands/lifecycle.rs` async functions. |
| SF-00102 | Done | MEDIUM | Very high | Split orchestrator god object — Extracted 4 modules from core.rs (2329 → 1504 lines, 35% reduction): `scripts.rs` (ScriptRunner), `orphans.rs` (OrphanCleaner), `health.rs` (HealthCheckRunner), `ports.rs` (port utilities). All runners hold `&Orchestrator` and are constructed on-demand. Public API unchanged. |
| SF-00103 | Done | MEDIUM | High medium | Unify error boundary between lib and command crates — Standardized all commands on `anyhow::Result`. Removed unnecessary `map_err` wrappers in main.rs. Converted string errors in `script.rs` and `session.rs` to library Error variants (`ScriptNotFound`, `Session`) so `suggestion()` hints work consistently. |
| SF-00104 | Done | CRITICAL | High medium | Isolated script clears shared state tracker — Fixed: Added `SqliteStateTracker::new_ephemeral()` which uses an in-memory SQLite database with no file lock. `run_script_isolated()` now replaces the child orchestrator's state tracker with an ephemeral one, so `clear()` and all writes stay in-memory and never touch the parent's `.fed/lock.db`. |
| SF-00105 | Done | HIGH | Low medium | Script failure bypasses cleanup for started dependencies — Fixed: Replaced `std::process::exit(code)` with `Err(ScriptFailed { name, exit_code })`. Error propagates through normal control flow so Drop impls and async cleanup run. `main()` extracts exit code from `ScriptFailed` silently (script's own stderr is the user feedback). |
| SF-00106 | Pending | LOW | Low | `QuietOutput` struct is never constructed — Dead code from SF-00099. `QuietOutput` was created for TUI suppression but is never instantiated. Either wire it up in the TUI path or remove it to eliminate the compiler warning. |
